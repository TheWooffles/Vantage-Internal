if _G.UnloadVantage then
    _G.UnloadVantage()
end

--// Libraries
local syde = loadstring(game:HttpGet("https://raw.githubusercontent.com/essencejs/syde/main/source",true))()
local VantageEsp = loadstring(game:HttpGet("https://raw.githubusercontent.com/TheWooffles/Vantage-Internal/main/VantageEsp"))()

--// Services & Variables
local Players          = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TeleportService  = game:GetService("TeleportService")
local RunService       = game:GetService("RunService")
local LocalPlayer      = Players.LocalPlayer
local Camera           = workspace.CurrentCamera

--// Connections & States
drawings    = {}
connections = {}

--// Config
_G.Config = {
    MouseLock = {
        Enabled = false,
        Keybind = Enum.KeyCode.LeftBracket,
        TeamCheck = false,
        WallCheck = false,
        TargetPart = "Head",
		Mode = "Fov", -- "Fov" | "NoFov"
		Radius = 70,
		Smoothness = 0.2
    },
}

--// User Interface
syde:Load({
	Logo = '7488932274',
	Name = 'Vantage Internal',
	Status = 'Stable',
	Accent = Color3.fromRGB(255, 255, 255),
	HitBox = Color3.fromRGB(255, 0, 0),
	AutoLoad = false,
	Socials = {
		{
			Name = 'Syde';
			Style = 'Discord';
			Size = "Large";
			CopyToClip = false
		},
		{
			Name = 'GitHub';
			Style = 'GitHub';
			Size = "Small";
			CopyToClip = false
		}
	},
	ConfigurationSaving = {
		Enabled = true,
		FolderName = 'Vantage',
		FileName = "Config"
	},
	AutoJoinDiscord = { 
		Enabled = false,
		Invite = "CZRZBwPz",
		RememberJoins = false
	},
})

local Window = syde:Init({
	Title = 'Vantage Internal';
	SubText = 'Made With ðŸ’“ By @Cncspt'
})

local Combat  = Window:InitTab({ Title = 'Combat' })
local Visuals = Window:InitTab({ Title = 'Visuals' })
local Player  = Window:InitTab({ Title = 'Player' })
local World   = Window:InitTab({ Title = 'World' })
local Misc    = Window:InitTab({ Title = 'Misc' })

Combat:Section('Aim Lock')
Combat:Toggle({
	Title = 'Team Check',
	Value = true,
	Config = true,
	CallBack = function(v)
		_G.Config.MouseLock.TeamCheck = v
	end,
	Flag = 'AimLockTeamCheck'
})
Combat:Toggle({
	Title = 'Wall Check',
	Value = true,
	Config = true,
	CallBack = function(v)
		_G.Config.MouseLock.WallCheck = v
	end,
	Flag = 'AimLockWallCheck'
})
Combat:CreateSlider({
	Title = 'Aim Lock Options',
	Description = '',
	Sliders = {
		{
			Title = 'FOV Size',
			Range = {10, 200},
			Increment = 5,
			StarterValue = _G.Config.MouseLock.Radius,
			CallBack = function(v)
				_G.AimLock.FOVSize = v
			end,
			Flag = 'AimLockFOVSize'
		},
		{
			Title = 'Smoothness',
			Range = {0, 1},
			Increment = 0.01,
			StarterValue = _G.Config.MouseLock.Smoothness,
			CallBack = function(v)
				_G.Config.MouseLock.Smoothness = v
			end,
			Flag = 'AimLockSmoothness'
		},
	}
})

Visuals:Section('Enemy Esp')
Visuals:Toggle({
	Title = 'Enabled',
	Value = false,
	Config = true,
	CallBack = function(v)
		_G.ESP.Toggle(v)
	end,
	Flag = 'EspEnabled'
})
Visuals:Toggle({
	Title = 'Team Check',
	Value = true,
	Config = true,
	CallBack = function(v)
		_G.ESP.SetTeamCheck(v)
	end,
	Flag = 'EspTeamCheck'
})

Misc:Section('Server')
Misc:Button({
	Title = 'Rejoin Server',
	Description = 'Rejoins Current Server',
	Type = 'Default',
	HoldTime = 2,
	CallBack = function()
        syde:Notify({
            Title = 'Rejoin Server',
            Content = 'Rejoining current server...',
            Duration = 5
        })
        task.wait(0.7)
        TeleportService:TeleportToPlaceInstance(game.PlaceId, game.JobId, LocalPlayer)
	end,
})

drawings.Cursor = Drawing.new("Circle")
drawings.Cursor.Position = Vector2.new(UserInputService:GetMouseLocation().X, UserInputService:GetMouseLocation().Y)
drawings.Cursor.Visible = false
drawings.Cursor.Radius = _G.Config.MouseLock.Radius
drawings.Cursor.Transparency = 0.5
drawings.Cursor.Thickness = 1
drawings.Cursor.Filled = false
drawings.Cursor.Color = Color3.fromRGB(255,255,255)

UserInputService.MouseIcon = 'http://www.roblox.com/asset?id=4882930015'

local function isPlayerAlive(player)
    if not player or not player.Character then return false end
    local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
    return humanoid and humanoid.Health > 0
end

local function isTargetVisible(targetPart, targetCharacter)
    if not _G.Config.MouseLock.WallCheck then
        return true
    end
    
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("Head") then
        return false
    end
    
    local origin = Camera.CFrame.Position
    local direction = (targetPart.Position - origin).Unit * (targetPart.Position - origin).Magnitude
    
    local raycastParams = RaycastParams.new()
    local filterList = {LocalPlayer.Character, targetCharacter}
    
    for _, player in pairs(Players:GetPlayers()) do
        if player.Character then
            table.insert(filterList, player.Character)
        end
    end
    
    raycastParams.FilterDescendantsInstances = filterList
    raycastParams.FilterType = Enum.RaycastFilterType.Exclude
    
    local rayResult = workspace:Raycast(origin, direction, raycastParams)
    
    return rayResult == nil
end

local function getClosestPlayerToMouse()
    local closestPlayer = nil
	if _G.Config.MouseLock.Mode == "Fov" then
    	shortestDistance = _G.Config.MouseLock.Radius
	elseif _G.Config.MouseLock.Mode == "NoFov" then
		shortestDistance = math.huge
	end
		
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and isPlayerAlive(player) then
            
            if _G.Config.MouseLock.TeamCheck and player.Team and LocalPlayer.Team and player.Team == LocalPlayer.Team then
                continue
            end
            
            local targetPart = player.Character:FindFirstChild(_G.Config.MouseLock.TargetPart) or player.Character:FindFirstChild("Head")
            
            if targetPart then
                local partPos = targetPart.Position
                local screenPos, onScreen = Camera:WorldToScreenPoint(partPos)
                
                if onScreen then
                    local screenPosVec = Vector2.new(screenPos.X, screenPos.Y)
					MousePos = Vector2.new(LocalPlayer:GetMouse().X, LocalPlayer:GetMouse().Y)
                    local distanceFromMouse = (MousePos - screenPosVec).Magnitude
                    
                    if isTargetVisible(targetPart, player.Character) then
                        if distanceFromMouse < shortestDistance then
                            shortestDistance = distanceFromMouse
                            closestPlayer = player
                        end
                    end
                end
            end
        end
    end
    
    return closestPlayer
end

connections.MouseLock = RunService.RenderStepped:Connect(function()
    drawings.Cursor.Position = Vector2.new(UserInputService:GetMouseLocation().X, UserInputService:GetMouseLocation().Y)
    if not isPlayerAlive(LocalPlayer) then
        targetPlayer = nil
    end
    
    if _G.Config.MouseLock.Enabled then
        local newTarget = getClosestPlayerToMouse()
        
        if newTarget and newTarget ~= targetPlayer then
            targetPlayer = newTarget
        elseif not newTarget and targetPlayer then
            targetPlayer = nil
        end
        
        if targetPlayer and targetPlayer.Character then
            local targetPart = targetPlayer.Character:FindFirstChild(_G.Config.MouseLock.TargetPart) or targetPlayer.Character:FindFirstChild("Head")
            
            if targetPart then
                local partPos = targetPart.Position
                local screenPos, onScreen = Camera:WorldToScreenPoint(partPos)
                if onScreen then
                    local mousePos = Vector2.new(LocalPlayer:GetMouse().X, LocalPlayer:GetMouse().Y)
                    local targetPos = Vector2.new(screenPos.X, screenPos.Y)
					local Pos
					if _G.Config.MouseLock.Smoothness == 1 then
						Pos = Vector2.new(screenPos.X, screenPos.Y)
					elseif _G.Config.MouseLock.Smoothness < 1 then
						Pos = mousePos:Lerp(targetPos, math.clamp(_G.Config.MouseLock.Smoothness, 0, 1))
					end
                    local delta = Pos - mousePos
                    mousemoverel(delta.X, delta.Y)
                end
            end
        end
    else
        targetPlayer = nil
    end
end)

connections.InputBegan = UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == _G.Config.MouseLock.Keybind then
        _G.Config.MouseLock.Enabled = not _G.Config.MouseLock.Enabled
		if _G.Config.MouseLock.Enabled then
			drawings.Cursor.Visible = true
			print("[Vantage] :: Locked")
		elseif not _G.Config.MouseLock.Enabled then
			drawings.Cursor.Visible = false
			print("[Vantage] :: Unlocked")
		end
    end
end)

_G.UnloadVantage = function()
    for _, connection in pairs(connections) do
        connection:Disconnect()
    end
    for _, drawing in pairs(drawings) do
        drawing:Destroy()
    end
	UserInputService.MouseIcon = ''
    print("[Vantage] :: Unloaded!")
end

print("[Vantage] :: loaded")
